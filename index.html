<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>The S3 Log Analyser</title>
    <!-- CSS Libraries -->
    <link rel="stylesheet" href="./lib/css/bootstrap.min.css" />
    <link rel="stylesheet" href="./lib/css/dc.min.css" />
    <link rel="stylesheet" href="./lib/css/fontawesome.min.css" />
    <!-- App CSS -->
    <link rel="stylesheet" href="./styles/main.css" />
    <!-- JS Libraries -->
    <script defer src="./lib/js/jquery-3.4.1.min.js"></script>
    <script defer src="./lib/js/bootstrap.bundle.min.js"></script>
    <script defer src="./lib/js/aws-sdk-2.461.0.min.js"></script>
    <script defer src="./lib/js/d3.min.js"></script>
    <script defer src="./lib/js/crossfilter.min.js"></script>
    <script defer src="./lib/js/dc.min.js"></script>
    <!-- App JS -->
    <script defer src="./scripts/forms.js"></script>
    <script defer src="./scripts/aws.js"></script>
    <script defer src="./scripts/filters.js"></script>
    <script defer src="./scripts/errors.js"></script>
    <script defer src="./scripts/charts.js"></script>
</head>
<body>
    <div id="app-container" class="container-fluid">
        <!-- Site Header -->
        <header class="row fixed-top align-items-center flex-nowrap py-2">
            <div class="d-none d-lg-block col-lg-3"></div>
            <div class="col-7 col-lg-6">
                <h1 class="text-center mb-0">The S3 Log Analyser</h1>
            </div>
            <div class="col-5 col-lg-3 text-center">
                <button type="button" class="btn btn-warning btn-lg" data-toggle="modal" data-target="#modal-help">Help..</button>
            </div>
        </header>
        <!-- Intro Text -->
        <div class="row card m-3">
            <div class="card-body">                
                <h4 class="text-center"><strong>Welcome to The S3 Log Analyser, a tool for visualising access logs generated by Amazon Web Services (AWS).</strong></h4>
                <p class="text-justify text-lg-center mb-0">Specifically, this tool interprets log files generated by AWS when requests are made to an S3 bucket (e.g. for a static website) or to a 
                CloudFront distribution.<br>Log files need to be stored in an S3 bucket that can be accessed using credentials you enter below. Take a look at 
                the help for further information.</p>
            </div>
        </div>
        <!-- Helper Graphics -->
        <div class="row">
            <div class="col-12 col-lg-5 text-center pb-2">
                <i class="fas fa-arrow-circle-down"></i><span class="align-super"> Start Here</span>
            </div>
        </div>
        <!-- App Setup -->
        <div class="row justify-content-around">
            <!-- API Credentials Section -->
            <section id="section-api-creds" class="col-11 col-lg-5 m-2 py-2 rounded highlight-form">                
                <h2 class="text-center">Connect to an S3 Bucket</h2>
                <div class="mb-0">
                    <p class="text-center mb-0"><strong class="align-super">Enter AWS credentials below </strong><i class="fas fa-chevron-circle-down"></i> <small class="align-super">(or load some saved ones if you have been here before)</small></p>
                    <p class="text-center"></p>
                    <p class="text-justify">You will need to have permission to make GET requests to the bucket, take a look at the help for
                    more information. Credentials are <u>never</u> transmitted to our servers & saved credentials are only stored in your browser. To prevent your browser becoming
                    unresponsive only the <strong>first 10,000</strong> objects in the bucket will be processed.</p>               
                </div>                                           
                <!-- Load Saved Credentials Buttons -->     
                <div id="buttons-load-saved">
                    <div class="btn-group mb-3 float-lg-left" id="buttons-load-local-saved" role="group">
                        <button type="button" class="btn btn-secondary" onclick="loadSavedCreds();" disabled>Load Saved</button>
                        <button type="button" class="btn btn-danger" onclick="clearSavedCreds();" disabled><small>Clear</small></button>                         
                    </div>
                    <button class="btn btn-warning float-right mb-3" onclick="loadDemoCredentials();">Use DEMO Creds</button>
                </div>                                             
                <!-- Enter AWS Credentials Form -->
                <form id="form-api-creds" class="" onsubmit="return submitCredsForm(this);">
                    <div class="form-group">                            
                        <input type="text" class="form-control form-control-lg" id="access-key-id" name="keyId" aria-describedby="key-id-help" placeholder="Access Key ID" required>
                        <small id="key-id-help" class="form-text text-muted">Your AWS API Key ID</small>
                    </div>
                    <div class="form-group">                            
                        <input type="password" class="form-control form-control-lg" id="access-key-secret" name="keySecret" aria-describedby="secret-help" placeholder="Secret" required>
                        <small id="secret-help" class="form-text text-muted">The key's secret</small>
                    </div>
                    <div class="form-row">
                        <div class="col">                                
                            <select class="form-control" id="aws-region-select" name="awsRegion" aria-describedby="aws-region-help" required>
                                <!-- Options added by JS -->
                            </select>
                            <small id="aws-region-help" class="form-text text-muted">Region in which your S3 bucket is hosted</small>
                        </div>
                        <div class="col">
                            <input type="text" class="form-control" id="bucket-name" name="bucketName" aria-describedby="bucket-name-help" placeholder="Bucket Name" required>
                            <small id="bucket-name-help" class="form-text text-muted">Name of the bucket containing the log files</small>
                        </div>                            
                    </div>
                    <div class="row align-items-center justify-content-end">
                        <div class="col col-lg-4">                        
                            <button type="submit" class="btn btn-outline-success btn-sm my-3" onclick="saveCredsFlag = false;">Connect without saving credentials in browser</button> 
                        </div>
                        <div class="col text-right">
                            <button type="submit" class="btn btn-success btn-lg my-3" onclick="saveCredsFlag = true;">Connect</button>
                        </div>
                    </div>                                        
                </form>                                                                                                             
            </section>
            <!-- API Connect Message Area -->
            <div id="message-area-api-connect" class="col-11 col-lg-1 my-2 text-center px-lg-0">                                           
                <div id="message-area-api-connect-loading" class="py-3 font-weight-bold">
                    <div class="spinner-border" role="status"></div>     
                    <!-- JS -->
                </div>
                <table id="table-object-count" class="table table-sm table-bordered py-2">
                    <tr>
                        <td>Objects</td>
                        <td id="message-area-api-connect-counter">0<!-- JS --></td>
                    </tr>
                </table>
                <table id="table-object-stats" class="table table-sm table-bordered py-2">
                    <thead class="thead-dark">
                        <tr>
                            <th colspan="2"><strong>Log Types</strong></th>
                        </tr>     
                    </thead>
                    <tr>
                        <td>S3</td>
                        <td id="message-area-api-connect-other-count">-<!-- JS --></td>
                    </tr>
                    <tr>
                        <td>CloudFront</td>
                        <td id="message-area-api-connect-gz-count">-<!-- JS --></td>
                    </tr>
                    <tr>
                        <td><i>Ignored</i></td>
                        <td id="message-area-api-connect-removed-count">-<!-- JS --></td>
                    </tr>                   
                </table>               
                <div id="instruction-select-filter" class="py-3">
                    <i class="fas fa-arrow-circle-down d-lg-none"></i>
                    <i class="fas fa-arrow-circle-right d-none d-lg-inline"></i><br>
                    Now filter by type and date
                </div>                                
            </div>           
            <!-- Filter Log Files Section -->
            <section id="section-filter-logs" class="col-11 col-lg-5 m-2 py-2 rounded">                                                        
                <div class="text-center">
                    <h2>Filter Log Files</h2>
                    <small><span class="align-super">Start by selecting a log type </span><i class="fas fa-chevron-circle-down"></i></small>
                </div>                               
                <!-- Filter Log Files Form -->
                <form id="form-filter-log-files" onsubmit="return submitFilterForm();">
                    <fieldset id="fieldset-log-file-type" class="form-group border p-2 text-center">
                        <legend class="text-left">Select Log Type</legend>
                        <div class="custom-control custom-radio custom-control-inline">
                            <input class="custom-control-input" type="radio" name="log-file-type" id="type-s3-log-file" value="s3Log" onclick="filterListByType('S3Log');" required disabled>
                            <label class="custom-control-label" for="type-s3-log-file">S3 Access Log (.txt)</label>
                        </div>
                        <div class="custom-control custom-radio custom-control-inline">
                            <input class="custom-control-input" type="radio" name="log-file-type" id="type-cloudfront-log-file" value="cfLog" onclick="filterListByType('CloudFront');" required disabled>
                            <label class="custom-control-label" for="type-cloudfront-log-file">CloudFront Access Log (.gz)</label>
                        </div>
                    </fieldset>          
                    <div class="row align-items-center my-3">                        
                        <div class="col text-right"><small><i class="fas fa-chevron-circle-down"></i></small></div>
                        <div class="col-6 text-center"><small>Then select a date range or use the presets</small></div>
                        <div class="col"><small><i class="fas fa-chevron-circle-down"></i></small></div>                    
                    </div>
                    <div class="row">
                        <fieldset id="fieldset-log-file-date" class="col form-group border mx-2">
                            <legend>Filter By Date</legend>
                            <div class="form-group">
                                <label class="form-text text-muted" for="date-min">From:</label>
                                <input class="form-control" type="date" name="date-min" id="date-min" min="" max="" oninput="filterListByDate();" disabled>
                                <p class="text-right"><small>Earliest: <span id="info-date-min"><!-- JS Inserts --></span></small></p> 
                            </div>
                            <div class="form-group">
                                <label class="form-text text-muted" for="date-max">To:</label>                                                    
                                <input class="form-control" type="date" name="date-max" id="date-max" min="" max="" oninput="filterListByDate();" disabled>
                                <p class="text-right"><small>Latest: <span id="info-date-max"><!-- JS Inserts --></span></small></p> 
                            </div>                                                   
                        </fieldset>
                        <fieldset id="fieldset-log-file-presets" class="col form-group border mx-2">
                            <legend>Preset Filters</legend>
                            <div class="space-vertically ml-3">
                               <div class="vertically-spaced-item custom-control custom-radio py-1">
                                    <input class="custom-control-input" type="radio" name="preset-filter" id="1Week" value="1Week" onclick="filterListByPreset('1Week');" disabled>
                                    <label class="custom-control-label" for="1Week">Last 1 weeks</label>
                                </div>
                                <div class="vertically-spaced-item custom-control custom-radio py-1">
                                    <input class="custom-control-input" type="radio" name="preset-filter" id="1Month" value="1Month" onclick="filterListByPreset('1Month');" disabled>
                                    <label class="custom-control-label" for="1Month">Last 1 months</label>
                                </div>
                                <div class="vertically-spaced-item custom-control custom-radio py-1">
                                    <input class="custom-control-input" type="radio" name="preset-filter" id="6Month" value="6Months" onclick="filterListByPreset('6Month');" disabled>
                                    <label class="custom-control-label" for="6Month">Last 6 Months</label>
                                </div>
                                <div class="vertically-spaced-item custom-control custom-radio py-1">
                                    <input class="custom-control-input" type="radio" name="preset-filter" id="1Year" value="1Year" onclick="filterListByPreset('1Year');" disabled>
                                    <label class="custom-control-label" for="1Year">Last 12 Months</label>
                                </div>                                
                            </div>                            
                        </fieldset>
                    </div>
                    <div class="row align-items-center justify-content-between">
                        <div class="col">
                            <div class="badge badge-pill badge-info py-1 px-3">
                                <table>
                                    <tr>
                                        <td>Log Files<br>Selected</td>
                                        <td><span id="info-num-files-selected" class="badge badge-light ml-2 align-middle p-2">-<!-- JS --></span></td>
                                    </tr>                                    
                                </table>
                            </div>                                                            
                        </div>
                        <div class="col">
                            <button type="reset" id="button-reset-filter-form" class="btn btn-danger btn-sm" onclick="changeFilters();" disabled>Reset Filter</button> 
                        </div>
                        <div class="col text-right">                                             
                            <button type="button" id="button-submit-filter-form" class="btn btn-success btn-lg" onclick="return submitFilterForm();" disabled>Load & Display</button>                            
                        </div>                    
                    </div>                
                </form>                
            </section>            
        </div>
        <!-- Load Logs Message Area -->
        <div id="message-area-load-logs" class="row align-items-center my-3">                                        
            <div id="message-area-load-logs-loading" class="col align-middle font-weight-bold">
                <span class="spinner-border mr-2" role="status"></span><!--JS-->
            </div>
            <div class="col text-center">
                <div class="badge badge-pill badge-info p-2">
                    Logs Loaded:
                    <span id="message-area-load-logs-counter">0<!-- JS --></span>
                </div>
            </div>
            <div class="col text-right">
                <button type="button" class="btn btn-warning" onclick="changeFilters();">Change Filter</button>
            </div>            
        </div>        
        <!-- Visualised Data Section-->
        <section id="section-visualise-data" class="row mt-3">            
            <div id="heading-no-data" class="col text-center mt-3">                
                <p><span class="badge badge-info m-2">Chart Area</span>Nothing to show, use controls above to load some data <i class="fas fa-arrow-up"></i></p>
            </div>
            <!-- Chart Intro Text -->
            <article class="row card m-3">
                <div class="card-body pb-0">
                    <p class="text-center"><strong>Congratulations, we have retrieved some data to show!</strong></p>
                    <p class="text-justify text-lg-center">Browse the charts and tables below for an insight into access patterns over the time 
                        period selected. Use the pie charts to dynamically filter all the displays by clicking on segment of interest. Click the segment again to 
                        clear your selection. Change the date filter or reset the page using the buttons supplied.</p>
                </div>
            </article>
            <article id="chart-requests-over-time" class="col-12 chart">                
                <h2>Requests Over Time (per day)</h2>
                <!-- DC Chart Here -->
            </article>
            <article id="chart-requests-by-type" class="col-md-4 chart">                
                <h2>Method</h2>
                <!-- DC Chart Here -->
            </article>
            <article id="chart-requests-by-user-agent" class="col-md-4 chart">                
                <h2>User Agent</h2>
                <!-- DC Chart Here -->
            </article>
            <article id="chart-response-by-http-status" class="col-md-4 chart">                
                <h2>HTTP Status Code</h2>
                <!-- DC Chart Here -->
            </article>
            <article id="chart-bytes-sent-over-time" class="col-12 chart">                
                <h2>Bytes Sent Over Time (per day)</h2>
                <!-- DC Chart Here -->
            </article>
            <article id="chart-requests-by-protocol" class="col-md-4 chart">                
                <h2>HTTP/HTTPS</h2>
                <!-- DC Chart Here -->
            </article>
            <article id="" class="col-md-4 chart">                
                <h2>Top 10 URL Paths Requested</h2>
                <table id="leaderboard-files-by-count" class="table table-striped table-bordered text-center leaderboard"><!-- DC Table Here --></table>
            </article>
            <article id="" class="col-md-4 chart">                
                <h2>Slowest 10 Requests<br><small>by Average Processing Time</small></h2>
                <table id="leaderboard-files-by-time" class="table table-striped table-bordered text-center leaderboard"><!-- DC Table Here --></table>
            </article>
        </section>
        <!-- Site Footer -->
        <footer class="row justify-content-center align-items-center">
            <div class="col-10">
                <div class="row justify-content-center my-2">
                    <div class="col col-4">                                               
                        <button type="reset" class="btn btn-danger" onclick="resetPage();">RESET</button>
                    </div>
                    <div id="button-change-filter-footer" class="col col-4">
                        <button  type="button" class="btn btn-warning" onclick="changeFilters();">Change Filter</button>
                    </div>
                </div>
            </div>            
            <div class="col-11 col-md-2 text-center">
                <strong>&copy; David Bland 2019</strong>
            </div>            
        </footer>       
    </div>
    <!-- MODALS -->
    <!-- Error Modal -->
    <div class="modal fade" id="modal-error-messages" tabindex="-1" role="dialog" aria-labelledby="error-modal-title" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="error-modal-title">Some Errors Occured</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div id="modal-error-message-area" class="modal-body">
                    <!-- Eror message content via JS -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="button-error-modal-continue" data-dismiss="modal" onclick="">Continue</button>
                    <button type="button" class="btn btn-danger" id="button-error-modal-go-back" data-dismiss="modal" onclick="errorModalGoBack('list');">Go Back</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Help Modal -->
    <div class="modal fade" id="modal-help" tabindex="-1" role="dialog" aria-labelledby="help-modal-title" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-success text-white text-center">
                    <h2 class="modal-title" id="help-modal-title"><strong>Documentation</strong></h2>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div id="modal-help" class="modal-body">
                    <p><strong>The S3 Log Analyser</strong> interprets two common types of log files generated by AWS. They are ‘Server Access Logs’ for an S3 bucket or 
                        ‘User Request Logs’ for a CloudFront distribution.</p>
                    <p>The tool retrieves log files stored in a single S3 bucket and does NOT modify the logs in any way. Once retrieved, the log files are parsed into 
                        a data set and visualised by way of chart and tables. Each visualisation has a title to explain what dimension of the data is being displayed.</p>
                    <p>A demonstration data set it available by selecting <em>Use Demo Creds</em> which will cause the credentials form to be pre-populated with details 
                        of a bucket containing real log files. Proceed as per the below instructions to view the demo data.</p>
                    <p>Currently, The S3 Log Analyser is confirmed to <strong>work only in Chrome Browser version 75 and above.</strong></p>
                    <h6><u><strong>Using The S3 Log Analyser</strong></u></h6>
                    <ol class="text-justify">
                        <li>
                            <p>Ensure you have a minimum of one log file available and stored in an S3 bucket. The log files can be either automatically 
                            generated in the bucket by AWS or manually transferred there by other means (so long as the format and key name have not been changed).</p>
                            <p class="text-center"><a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/ServerLogs.html" target="_blank" class="badge badge-info">Setting up S3 Server Access Logging <i class="fas fa-external-link-alt"></i></a></p>
                            <p class="text-center"><a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/AccessLogs.html" target="_blank" class="badge badge-info">Setting up CloudFront Logging <i class="fas fa-external-link-alt"></i></a></p>
                        </li>
                        <li>
                            <p>Create an AWS user that has programmatic access to the S3 bucket containing the log files. The user must have permission to perform 
                            both <mark>ListBucket</mark> and <mark>GetObject</mark> actions on the bucket in question. We strongly suggest that for the purposes of using this tool you 
                            create a dedicated user via IAM console whose permissions are limited ONLY to those above.</p>
                            <p class="text-center"><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html" target="_blank" class="badge badge-info">AWS User Management <i class="fas fa-external-link-alt"></i></a></p>
                            <p>Create an Access Key for the user and note the key secret.</p>
                        </li>
                        <li>
                            <p>On The S3 Log Analyser enter the access key and secret from step 2 as well as selecting the region in which the bucket is hosted and 
                            inputting the exact bucket name.</p>
                            <p>Use either <em>Connect</em> button to initiate a connection with AWS. If you do not wish your AWS credentials to be saved locally in your browser 
                            select <em>Connect without saving credentials in browser</em>.</p>
                        </li>
                        <li>
                            <p>If connection has been successful and log files have been found in the bucket then The S3 Log Analyser will present some stats on the 
                            number and type of each log file found. You will now be able to move on to filtering the logs in step 5.</p>
                            <p>If connection has not been successful or there have been issues locating log files then a relevant error message will be presented. 
                            Provided none of the errors are fatal then you will be able to continue.</p>
                        </li>
                        <li>
                            <p>The S3 Log Analyser allows you filter the log files found by date. This permits you to visualise a particular date range that you may be 
                            interested in. Start the filtering process by selecting which type of log file you would like to view, then either select a date range 
                            or use a preset filter. To change the filter simply click <em>Reset Filter</em> at any time. The number of log files that are to be loaded will 
                            appear beneath the form. Click <em>Load & Display</em> when you are ready to visualise the data.</p>
                            <p>To view all the log files found simply select the type and click <em>Load & Display</em> without setting a date filter.</p>                    
                            <p><em>** When you click </em>Load & Display<em>, The S3 Log Analyser will fetch each of the log files from the bucket and interpret them. This may take 
                            some time, particularly for very large data sets. In addition, CloudFront Access Logs will take longer to load than S3 Access Logs due to 
                            the way they are compressed. **</em></p>
                        </li>
                        <li>
                            <p>Once the log files are loaded the charts and tables will appear below the form elements. Browse through them to get an insight into the 
                            content of the logs. Pie chart segments can be clicked on to dynamically filter all the charts and tables according to the selected 
                            segment. Click again on the segment to clear the filter or click another segment to filter again.</p>
                        </li>
                    </ol>
                    <p>To change the date filter whilst keeping your current AWS connection click the <em>Change Filter</em> button above the charts or the in the page 
                        footer. To reset The S3 Log Analyser simply hit <em>Reset</em> in the footer at any time.</p>
                    <p>NB. Objects in the bucket containing the log files do not need to be publicly accessible but the bucket itself must permit the authorized 
                        user to make GET requests from any origin.</p>
                        
                    <p class="text-center">For further help contact <a href="mailto:the-s3-log-analyser@daveb.me.uk"><strong>the-s3-log-analyser@daveb.me.uk</strong></a></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>